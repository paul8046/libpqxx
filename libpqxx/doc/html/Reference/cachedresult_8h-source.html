<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>libpqxx: cachedresult.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>cachedresult.h</h1><a href="cachedresult_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*-------------------------------------------------------------------------</span>
00002 <span class="comment"> *</span>
00003 <span class="comment"> *   FILE</span>
00004 <span class="comment"> *      pqxx/cachedresult.h</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *   DESCRIPTION</span>
00007 <span class="comment"> *      definitions for the pqxx::cachedresult class and support classes.</span>
00008 <span class="comment"> *   pqxx::cachedresult is a lazy-fetching, transparently-cached result set</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * Copyright (c) 2001-2003, Jeroen T. Vermeulen &lt;jtv@xs4all.nl&gt;</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * See COPYING for copyright license.  If you did not receive a file called</span>
00013 <span class="comment"> * COPYING with this source code, please notify the distributor of this mistake,</span>
00014 <span class="comment"> * or contact the author.</span>
00015 <span class="comment"> *</span>
00016 <span class="comment"> *-------------------------------------------------------------------------</span>
00017 <span class="comment"> */</span>
00018 <span class="preprocessor">#ifndef PQXX_CACHEDRESULT_H</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#define PQXX_CACHEDRESULT_H</span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor">#include &lt;map&gt;</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="cursor_8h.html">pqxx/cursor.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="result_8h.html">pqxx/result.h</a>"</span>
00025 
<a name="l00026"></a><a class="code" href="namespacepqxx.html">00026</a> <span class="keyword">namespace </span>pqxx
00027 {
00028 
00029 <span class="comment">// TODO: Forward-only mode of operation?  Or write separate stream class?</span>
00030 
<a name="l00051"></a><a class="code" href="classpqxx_1_1cachedresult.html">00051</a> <span class="keyword">class </span>PQXX_LIBEXPORT cachedresult
00052 {
00053 <span class="keyword">public</span>:
<a name="l00054"></a><a class="code" href="classpqxx_1_1cachedresult.html#w0">00054</a>   <span class="keyword">typedef</span> result::size_type size_type;
<a name="l00055"></a><a class="code" href="classpqxx_1_1cachedresult.html#w1">00055</a>   <span class="keyword">typedef</span> size_type blocknum;
00056 
<a name="l00058"></a><a class="code" href="classpqxx_1_1cachedresult.html#w2">00058</a>   <span class="keyword">typedef</span> <a class="code" href="classpqxx_1_1result_1_1tuple.html">result::tuple</a> tuple;
00059 
<a name="l00061"></a><a class="code" href="classpqxx_1_1cachedresult.html#w3">00061</a>   <span class="keyword">typedef</span> tuple Tuple;
00062 
00074   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> TRANSACTION&gt; <span class="keyword">explicit</span>
<a name="l00075"></a><a class="code" href="classpqxx_1_1cachedresult.html#a0">00075</a>     cachedresult(TRANSACTION &amp;T,
00076                  <span class="keyword">const</span> <span class="keywordtype">char</span> Query[],
00077                  <span class="keyword">const</span> PGSTD::string &amp;BaseName=<span class="stringliteral">"query"</span>,
00078                  size_type Granularity=100) :                           <span class="comment">//[t40]</span>
00079       m_Granularity(Granularity),
00080       m_Cache(),
00081       m_Cursor(T, Query, BaseName, Granularity),
00082       m_EmptyResult(),
00083       m_HaveEmpty(false)
00084   {
00085     <span class="comment">// Trigger build error if T has insufficient isolation level</span>
00086     error_permitted_isolation_level(<span class="keyword">typename</span> TRANSACTION::isolation_tag());
00087     init();
00088   }
00089 
00090 
00091   <span class="comment">// TODO: Iterators, begin(), end()</span>
00092   <span class="comment">// TODO: Metadata</span>
00093   <span class="comment">// TODO: Block replacement (limit cache size); then add capacity()</span>
00094 
00096 
<a name="l00104"></a><a class="code" href="classpqxx_1_1cachedresult.html#a1">00104</a>   <span class="keyword">const</span> tuple operator[](size_type i) <span class="keyword">const</span>                             <span class="comment">//[t41]</span>
00105         { <span class="keywordflow">return</span> GetBlock(BlockFor(i))[Offset(i)]; }
00106 
00108 
<a name="l00119"></a><a class="code" href="classpqxx_1_1cachedresult.html#a2">00119</a>    <span class="keyword">const</span> tuple at(size_type i) <span class="keyword">const</span>                                    <span class="comment">//[t40]</span>
00120         { <span class="keywordflow">return</span> GetBlock(BlockFor(i)).<a class="code" href="classpqxx_1_1result_1_1tuple.html#a5">at</a>(Offset(i)); }
00121 
00123   size_type size() <span class="keyword">const</span>;                                               <span class="comment">//[t40]</span>
00124   
00126   <span class="keywordtype">bool</span> empty() <span class="keyword">const</span>;                                                   <span class="comment">//[t47]</span>
00127 
00128 <span class="keyword">private</span>:
00129   <span class="keyword">typedef</span> Cursor::pos pos;
00130 
00132 
00137   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> ISOLATIONTAG&gt;
00138     <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> error_permitted_isolation_level(ISOLATIONTAG) <span class="keywordflow">throw</span>();
00139 
00140   <span class="keywordtype">void</span> init();
00141 
00142   blocknum BlockFor(size_type Row) <span class="keyword">const</span> <span class="keywordflow">throw</span> () 
00143         { <span class="keywordflow">return</span> Row / m_Granularity; }
00144   size_type Offset(size_type Row) <span class="keyword">const</span> <span class="keywordflow">throw</span> ()
00145         { <span class="keywordflow">return</span> Row % m_Granularity; }
00146   Cursor::size_type FirstRowOf(blocknum Block) <span class="keyword">const</span> <span class="keywordflow">throw</span> ()
00147         { <span class="keywordflow">return</span> Block*m_Granularity; }
00148 
00149   <span class="keywordtype">void</span> MoveTo(blocknum) <span class="keyword">const</span>;
00150 
00152   <span class="keyword">const</span> result &amp;Fetch() <span class="keyword">const</span>;
00153 
00154   <span class="keyword">const</span> result &amp;GetBlock(blocknum b)<span class="keyword"> const</span>
00155 <span class="keyword">  </span>{
00156     CacheMap::const_iterator i = m_Cache.find(b);
00157     <span class="keywordflow">if</span> (i != m_Cache.end()) <span class="keywordflow">return</span> i-&gt;second;
00158 
00159     MoveTo(b);
00160     <span class="keywordflow">return</span> Fetch();
00161   }
00162 
00164   size_type m_Granularity;
00165 
00166   <span class="keyword">typedef</span> PGSTD::map&lt;blocknum, const result&gt; CacheMap;
00167   <span class="keyword">mutable</span> CacheMap m_Cache;
00168 
00169   <span class="keyword">mutable</span> Cursor m_Cursor;
00170   <span class="keyword">mutable</span> result m_EmptyResult;
00171   <span class="keyword">mutable</span> <span class="keywordtype">bool</span>   m_HaveEmpty;
00172 
00173   <span class="comment">// Not allowed:</span>
00174   cachedresult();
00175   cachedresult(<span class="keyword">const</span> cachedresult &amp;);
00176   cachedresult &amp;operator=(<span class="keyword">const</span> cachedresult &amp;);
00177 };
00178 
<a name="l00180"></a><a class="code" href="namespacepqxx.html#a0">00180</a> <span class="keyword">typedef</span> cachedresult <a class="code" href="classpqxx_1_1cachedresult.html">CachedResult</a>;
00181 
00182 <span class="keyword">template</span>&lt;&gt; <span class="keyword">inline</span> <span class="keywordtype">void</span>
00183 cachedresult::error_permitted_isolation_level(<a class="code" href="structpqxx_1_1isolation__traits.html">isolation_traits&lt;serializable&gt;</a>)
00184   <span class="keywordflow">throw</span> () {}
00185 
00186 } <span class="comment">// namespace pqxx</span>
00187 
00188 <span class="preprocessor">#endif</span>
00189 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Sat Jun 14 00:10:13 2003 for libpqxx by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.1 </small></address>
</body>
</html>
